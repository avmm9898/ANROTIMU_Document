# CAN通訊協議

本產品CAN介面遵循以下標準：

* CAN介面符合CANopen協議，所有通訊均使用標準數據幀，只使用PTO1-4 傳輸數據，所有傳輸均採用標準數據幀，不接收遠端幀和拓展數據幀
* 所有PTO採用非同步定時觸發模式。
* 提供eds檔案下載: [**TaskSlave.eds**](https://raw.githubusercontent.com/avmm9898/anrotimu_doc/master/03_Examples/can/TaskSlave.eds)
* 提供dbc檔案下載: [**CANopen.dbc**](https://raw.githubusercontent.com/avmm9898/anrotimu_doc/master/03_Examples/can/CANopen.dbc)

更詳細的使用請看產品說明書。

### CANopen 預設設定

| CANopen預設配置 | 值                     |
| ---------------- | ---------------------- |
| CAN 波特率      | 500KHz                 |
| CANopen節點ID   | 8                      |
| 初始化狀態      | Operational            |
| 心跳包          | 無                     |
| TPDO輸出速率    | 10Hz - 200Hz(每個TPDO) |


### CANopen TPDO

| PTO通道 | PTO 幀ID | 長度（DLC） | PTO 傳輸方式     | 非同步輸出頻率（Hz） | 發送數據 | 說明                                                         |
| ------- | -------- | ----------- | ---------------- | -------------------- | -------- | ------------------------------------------------------------ |
| TPDO1   | 0x180+ID | 6           | 非同步定時(0xFE) | 100                  | 加速度   | 數據型別為(int16,低位元組在前，每個軸2位元組，共6位元組)，分別為X,Y,Z軸加速度，單位為mG(0.001重力加速度) |
| TPDO2   | 0x280+ID | 6           | 非同步定時(0xFE) | 100                  | 角速度   | 數據型別為(int16,低位元組在前，每個軸2位元組，共6位元組)，分別為X,Y,Z軸角速度，單位為0.1DPS(°/s) |
| TPDO3   | 0x380+ID | 6           | 非同步定時(0xFE) | 100                  | 歐拉角   | 數據型別為(int16,低位元組在前，每個軸2位元組，共6位元組)，順序分別為 橫滾角:Roll, 俯仰角:Pitch, 航向角:Yaw。單位為0.01° |
| TPDO4   | 0x480+ID | 8           | 非同步定時(0xFE) | 100                  | 四元數   | 數據型別為(int16,低位元組在前,每個元素2位元組，共8位元組)，分別為$$ q_{w} \ q_{x}\ q_{y}\ q_{z}$$ 。單位四元數擴大10000倍后結果。如四元數為1,0,0,0 時, 輸出10000,0,0,0. |
| TPDO5   | 0x680+ID | 4           | 非同步定時(0xFE) | 20                   | 氣壓     | 單位Pa                                                       |


  ### CANOpen介面常用命令舉例

#### 1. 使能數據輸出(開啟非同步觸發)

發送標準CANopen協議幀，使用NMT: Start Remote Node命令:

`ID=0x000,DLC=2,DATA=0x01,0x08`

其中 0x01為Start Remote Node指令， 0x08為節點ID


#### 2. 修改CAN波特率，輸出速率及輸出幀資訊
數據字典以下位置存放廠商參數配置數據, 可通過CANopen 發送快速SDO指令修改，**掉電儲存，重新上電生效**。

| 數據字典位置 | 子偏移 | 名稱     | 值型別    | 預設值 | 說明            |
| ------------ | ------ | -------- | --------- | ------ | --------------- |
| 0x2100       | 0      | CAN_BAUD | INTEGER32 | 500000 | CAN匯流排波特率 |
| 0x2101       | 0      | NodeID   | INTEGER32 | 8      | 節點ID          |

以上配置操作均使用快速SDO來寫數據字典, 其中TPDO通道與其對應的參數索引為：

| PTO通道 | PTO 幀ID | TPDO參數索引地址(CANopen協議預設定義) |
| ------- | -------- | ------------------------------------- |
| TPDO1   | 0x180+ID | 0x1800                                |
| TPDO2   | 0x280+ID | 0x1801                                |
| TPDO3   | 0x380+ID | 0x1802                                |
| TPDO4   | 0x480+ID | 0x1803                                |
| TPDO5   | 0x680+ID | 0x1804                                |

##### 示例1: 修改CAN波特率

將CAN波特率修改爲125K, 則發送：

`ID=0x608 ,DLC=8,DATA=23,00,21,00,48,E8,01,00`(ID=0x608, 長度為8的標準數據幀)

* ID=0x608為快速寫SDO地址,其中8為預設節點ID，修改節點ID后要做相應修改,如CANopenID改為9后,ID=0x609.
* 0x23為SDO寫四個位元組指令 
* 0x00, 0x21為寫0x2100索引
* 0x00 子索引位置，預設0
* (4-7)0x00, 0x01, 0xE8, 0x48 = (0x00<<24) + (0x01<<16) + (0xE8<<8) + 0x48 = 125000

將CAN波特率修改爲250K, 發送：

`23,00,21,00,90,D0,03,00`

將CAN波特率修改爲1M,發送:

`23 00 21 00 40 42 0F 00`

##### 示例2: 修改節點ID

如將裝置CANopen節點ID改為9, 則發送：

`ID=0x608 ,DLC=8,DATA=23,01,21,00,09,00,00,00`

* 0x23為SDO寫四個位元組指令  
* 0x01, 0x21為寫0x2101索引
* 0x09 0x00, 0x00, 0x00 = (0x00<<24) + (0x00<<16) + (0x00<<8) + 0x09 = 9

注意：

1. ID修改範圍：1-64 

2. 修改節點ID後重新上電生效，且生效后發送啟動節點命令(比如節點啟動命令數據變為01 09)和SDO指令(發送CAN幀ID變為0x609)時注意為新的地址

##### 示例3: 修改/開啟/關閉 數據輸出速率

發送標準CANopen協議幀，使用標準快速SDO指令:(此項配置立即生效)

修改TPDO3(歐拉角)輸出速率為20Hz(每50ms輸出一次):

`ID=0x608 ,DLC=8,DATA=2B,02,18,05,32,00,00,00`

其中 

* 0x2B為SDO寫兩個位元組指令 
* 0x02, 0x18為寫0x1802索引,
* 0x05為子索引
* 0x00, 0x32= (0x00<<8) + 0x32 = 50(單位為ms)，後面不足補0.

將TPDO1(加速度)輸出速率修改爲10Hz(每100ms輸出一次):

`2B 00 18 05 64 00 00 00`

將TPDO2(角速度)輸出速率修改爲5Hz(每200ms輸出一次):

`2B 01 18 05 C8 00 00 00`

也可以通過修改輸出速率來關閉TPDO輸出(每0ms輸出一次代表關閉):

將TPDO2(角速度)定時輸出為0

`2B,01,18,05,00,00,00,00`

將TPDO1(加速度)輸出速率為0

`2B 00 18 05 00 00 00 00`

將TPDO3(歐拉角)輸出速率為0

`2B 02 18 05 00 00 00 00`

將TPDO4(四元數)輸出速率為0

`2B 03 18 05 00 00 00 00`

##### 示例4: 開啟/關閉站點

可以使用 NMT命令StartRemoteNode和 StopRemoteNode來開啟關閉節點:

* 開啟節點: `ID:0,DLC:2,DATA:01 08` 其中01為開啟節點命令，08為節點ID(出廠預設為8)
* 關閉節點: `ID:0,DLC:2,DATA:02 08` 其中02為關閉節點命令，08為節點ID(出廠預設為8)

##### 示例5: 配置TPDO為同步模式
先按示例4 中關閉所有TPDO(設定TPDO輸出速率為0)， 然後發送CANopen同步幀即可：

CANopen 同步幀: `ID:80 DLC:0, DATA:空` 



#### 3. 注意事項

* 所有配置修改後重新上電後生效